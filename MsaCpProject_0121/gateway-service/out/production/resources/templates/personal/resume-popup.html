<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>이력서 불러오기</title>
    <style>
        body { margin:0; font-family: Arial, sans-serif; }
        .topbar {
            height:64px; display:flex; align-items:center; justify-content:space-between;
            padding:0 24px; border-bottom:1px solid #eee;
        }
        .title { font-size:24px; font-weight:800; }
        .btn {
            border:0; padding:10px 18px; border-radius:999px; cursor:pointer;
            background:#333; color:#fff; font-weight:700;
        }
        .wrap { padding:24px; }
        .empty {
            margin-top:80px; text-align:center; color:#222; font-size:18px;
        }
        .list { max-width:820px; margin:24px auto 0; display:flex; flex-direction:column; gap:10px; }
        .row {
            border:1px solid #eee; border-radius:10px; padding:12px 14px;
            display:flex; gap:12px; align-items:flex-start; cursor:pointer;
        }
        .meta { display:flex; flex-direction:column; gap:4px; }
        .meta .h { font-weight:800; }
        .meta .s { font-size:13px; color:#666; }
        .actions {
            max-width:820px; margin:16px auto 0; display:flex; gap:10px; justify-content:flex-end;
        }
        .btn2 {
            border:1px solid #ddd; padding:10px 14px; border-radius:10px; cursor:pointer;
            background:#fff; font-weight:700;
        }
    </style>
</head>
<body>
<div class="topbar">
    <div class="title">이력서 불러오기</div>
    <button class="btn" id="closeBtn">닫기</button>
</div>

<div class="wrap">
    <div id="empty" class="empty" style="display:none;">
        You don’t have any resumes yet.
    </div>

    <div id="list" class="list" style="display:none;"></div>

    <div class="actions" id="actions" style="display:none;">
        <button class="btn2" id="loadSelectedBtn">선택 불러오기</button>
        <button class="btn2" id="loadLatestBtn">최신 1개 불러오기</button>
    </div>
</div>

<script>
    const ENDPOINT_RESUME_LIST = (page=0,size=20) => `/api/resume/list?page=${page}&size=${size}`;
    const ENDPOINT_RESUME_LATEST = `/api/resume/me`;

    const $ = (s) => document.querySelector(s);
    const listEl = $("#list");
    const emptyEl = $("#empty");
    const actionsEl = $("#actions");

    $("#closeBtn").addEventListener("click", () => window.close());

    async function fetchJson(url) {
        const res = await fetch(url, { method:"GET", credentials:"include", cache:"no-store" });
        if (res.status === 401) {
            alert("로그인 후 이용하세요.");
            window.close();
            throw new Error("401");
        }
        const ct = (res.headers.get("content-type") || "").toLowerCase();
        if (!res.ok) throw new Error("HTTP " + res.status);
        if (!ct.includes("application/json")) throw new Error("Not JSON");
        return await res.json();
    }

    function getPicked() {
        return document.querySelector('input[name="resumePick"]:checked')?.value || "";
    }

    function sendPicked(m110) {
        if (!window.opener) return;
        window.opener.postMessage({ type:"RESUME_PICKED", m110 }, window.location.origin);
        window.close();
    }

    async function renderList() {
        let raw;
        try {
            raw = await fetchJson(ENDPOINT_RESUME_LIST(0, 20));
        } catch (e) {
            // 목록 API가 아직 없으면 empty로 처리
            emptyEl.style.display = "block";
            listEl.style.display = "none";
            actionsEl.style.display = "none";
            return;
        }

        const data = raw?.data ?? raw;
        const items = data?.items ?? [];

        if (!items.length) {
            emptyEl.style.display = "block";
            listEl.style.display = "none";
            actionsEl.style.display = "none";
            return;
        }

        emptyEl.style.display = "none";
        listEl.style.display = "flex";
        actionsEl.style.display = "flex";
        listEl.innerHTML = "";

        items.forEach((it, idx) => {
            const m110 = it?.seqNoM110 ?? it?.SEQ_NO_M110;
            const insertDate = it?.insertDate ?? "-";
            const school = it?.school ?? "";
            const major = it?.major ?? "";

            const row = document.createElement("label");
            row.className = "row";
            row.innerHTML = `
          <input type="radio" name="resumePick" value="${m110}" ${idx===0?"checked":""} />
          <div class="meta">
            <div class="h">이력서 #${m110}</div>
            <div class="s">저장일: ${insertDate}</div>
            <div class="s">${school}${major ? " / " + major : ""}</div>
          </div>
        `;
            listEl.appendChild(row);
        });
    }

    $("#loadSelectedBtn")?.addEventListener("click", async () => {
        const picked = getPicked();
        if (!picked) return alert("이력서를 선택하세요.");
        sendPicked(picked);
    });

    $("#loadLatestBtn")?.addEventListener("click", async () => {
        try {
            const raw = await fetchJson(ENDPOINT_RESUME_LATEST);
            const data = raw?.data ?? raw;
            const m110 = data?.seqNoM110 ?? data?.SEQ_NO_M110 ?? data?.id;
            if (!m110) return alert("최신 이력서를 찾을 수 없습니다.");
            sendPicked(m110);
        } catch (e) {
            console.error(e);
            alert("최신 이력서를 불러올 수 없습니다.");
        }
    });

    renderList();
</script>
</body>
</html>
