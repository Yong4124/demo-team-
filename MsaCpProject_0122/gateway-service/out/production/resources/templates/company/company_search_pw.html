<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기업회원 비밀번호 찾기 - 주한미군 전역장병 채용 플랫폼</title>

    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/sub.css">
</head>

<script type="text/javascript">
    var resetToken = '';
    
    async function goFindPw() {
        var form = document.rpForm;
        
        if ((form.ID.value).length == 0) {
            alert('아이디를 입력해주세요.');
            form.ID.focus();
            return;
        }
        
        if ((form.MANAGER_NM.value).length == 0) {
            alert('담당자명을 입력해주세요.');
            form.MANAGER_NM.focus();
            return;
        }
        
        if ((form.EMAIL.value).length == 0) {
            alert('이메일을 입력해주세요.');
            form.EMAIL.focus();
            return;
        }
        
        try {
            const response = await fetch('/api/company/find-pw', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    loginId: form.ID.value,
                    managerNm: form.MANAGER_NM.value,
                    email: form.EMAIL.value
                })
            });
            const data = await response.json();
            
            if (data.success) {
                resetToken = data.token;
                document.getElementById('findArea').style.display = 'none';
                document.getElementById('resetArea').style.display = 'block';
                alert('회원 정보가 확인되었습니다. 새 비밀번호를 입력해주세요.');
            } else {
                alert(data.message || '일치하는 회원 정보가 없습니다.');
            }
        } catch (error) {
            alert('비밀번호 찾기 중 오류가 발생했습니다.');
        }
    }
    
    async function goResetPw() {
        var newPw = document.getElementById('NEW_PW').value;
        var newPwCf = document.getElementById('NEW_PW_CF').value;
        
        if (newPw.length == 0) {
            alert('새 비밀번호를 입력해주세요.');
            document.getElementById('NEW_PW').focus();
            return;
        }
        
        var pwRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,16}$/;
        if (!pwRegex.test(newPw)) {
            alert('비밀번호는 8~16자의 영문, 숫자, 특수기호를 포함해야 합니다.');
            document.getElementById('NEW_PW').value = '';
            document.getElementById('NEW_PW').focus();
            return;
        }
        
        if (newPwCf.length == 0) {
            alert('비밀번호 확인을 입력해주세요.');
            document.getElementById('NEW_PW_CF').focus();
            return;
        }
        
        if (newPw !== newPwCf) {
            alert('비밀번호가 일치하지 않습니다.');
            document.getElementById('NEW_PW_CF').value = '';
            document.getElementById('NEW_PW_CF').focus();
            return;
        }
        
        try {
            const response = await fetch('/api/company/reset-pw', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    token: resetToken,
                    newPassword: newPw
                })
            });
            const data = await response.json();
            
            if (data.success) {
                alert('비밀번호가 변경되었습니다. 로그인 페이지로 이동합니다.');
                window.location.href = '/company/login';
            } else {
                alert(data.message || '비밀번호 변경에 실패했습니다.');
            }
        } catch (error) {
            alert('비밀번호 변경 중 오류가 발생했습니다.');
        }
    }
</script>

<body class="sub">
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="wrapper">
<form name="rpForm" method="post">
<div class="sub_container">
<div class="container">
<div class="login_view">
    <div class="sub_tit mb20">비밀번호 찾기</div>
    <div class="sub_tab">
        <a href="/search-pw">개인회원</a>
        <a href="#" class="on">기업회원</a>
    </div>
    
    <!-- 회원정보 확인 영역 -->
    <div id="findArea" class="login_box">
        <div class="mar1">
            <input type="text" class="input" name="ID" maxlength="100" placeholder="아이디">
        </div>
        <div class="mar1">
            <input type="text" class="input" name="MANAGER_NM" maxlength="500" placeholder="담당자명">
        </div>
        <div class="mar2">
            <input type="text" class="input" name="EMAIL" maxlength="100" placeholder="이메일">
        </div>
        <div class="btn_area center">
            <a href="javascript:goFindPw();" class="btn-submit">비밀번호 찾기</a>
        </div>
    </div>
    
    <!-- 비밀번호 재설정 영역 -->
    <div id="resetArea" class="login_box" style="display:none;">
        <div class="mar1">
            <input type="password" class="input" id="NEW_PW" maxlength="100" placeholder="새 비밀번호 (8~16자, 영문/숫자/특수문자)">
        </div>
        <div class="mar2">
            <input type="password" class="input" id="NEW_PW_CF" maxlength="100" placeholder="새 비밀번호 확인">
        </div>
        <div class="btn_area center">
            <a href="javascript:goResetPw();" class="btn-submit">비밀번호 변경</a>
        </div>
    </div>
    
    <div class="join_info">
        <a href="/company/login">로그인</a>
        <span class="bar"></span>
        <a href="/company/search-id">아이디 찾기</a>
        <span class="bar"></span>
        <a href="/company/register">회원가입</a>
    </div>
</div>
</div>
</div>
</form>
    <div th:replace="~{fragments/footer :: footer}"></div>
</div>
<script src="/js/common.js?v=1"></script>
<script src="/js/main.js"></script>
</body>
</html>
